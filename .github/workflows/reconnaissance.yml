name: Reconnaissance

on:
  push:
    branches: [master]

jobs:
  scan-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Dependencies & Tools
        run: |
          sudo apt-get update && sudo apt-get install -y wget unzip jq golang-go
          
          # Install nuclei manually from release
          LATEST_VERSION=$(curl -s https://api.github.com/repos/projectdiscovery/nuclei/releases/latest | jq -r '.tag_name')
          CLEAN_VERSION=${LATEST_VERSION#v}
          wget https://github.com/projectdiscovery/nuclei/releases/download/${LATEST_VERSION}/nuclei_${CLEAN_VERSION}_linux_amd64.zip
          unzip -o nuclei_${CLEAN_VERSION}_linux_amd64.zip
          sudo mv nuclei /usr/bin/
          sudo chmod +x /usr/bin/nuclei
          sudo rm -rf nuclei* *.md

          # Install Go tools
          go install github.com/tomnomnom/assetfinder@latest && sudo mv ~/go/bin/assetfinder /usr/bin/
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest && sudo mv ~/go/bin/httpx /usr/bin/
          go install github.com/projectdiscovery/dnsx/cmd/dnsx@latest && sudo mv ~/go/bin/dnsx /usr/bin/
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest && sudo mv ~/go/bin/subfinder /usr/bin/

      - name: Subdomain Enumeration & Vulnerable Scan
        run: |
          set -e
          TARGET="bitpanda.com"
          TODAY=$(date +%F)
          mkdir -p Bitpanda

          echo "[*] Finding subdomains..."
          subfinder -d $TARGET -silent > sub1.txt
          assetfinder --subs-only $TARGET | grep "\.${TARGET}$" > sub2.txt
          cat sub1.txt sub2.txt | sort -u > Bitpanda/bitpanda.txt
          echo "[+] Total subdomains found: $(wc -l < Bitpanda/bitpanda.txt)"

          echo "[*] Probing live web apps..."
          cat Bitpanda/bitpanda.txt | httpx -p 80,443,8080,8443,3000,5000,8000,8888,10000,5601,9200,1337,7001,7000,9000 \
            -title -td -tech-detect -web-server -ip -status-code -method \
            -probe -follow-redirects -random-agent -fr \
            -silent -rate-limit 500 -timeout 10 -retries 3 -location \
            -o Bitpanda/subdomains-bitpanda-live.txt

          echo "[*] Resolving DNS..."
          cat Bitpanda/subdomains-bitpanda-live.txt | awk '{print $1}' | dnsx -silent -nc -a -cname -resp \
            -o Bitpanda/bitpanda-resolved.txt

          echo "[*] Running nuclei scan..."
          cat Bitpanda/bitpanda-resolved.txt | awk '{print $1}' | sort -u | nuclei -as \
            -H "X-Bug-Bounty: Bugcrowd-eno@bugcrowdninja.com" \
            -rl 300 -c 100 -retries 3 -timeout 15 \
            -stats -si 10 -sresp \
            -t dns/ -t cves/ -t misconfiguration/ -t exposures/ \
            -o Bitpanda/bitpanda-live-urls-$TODAY.txt

          echo "âœ… Recon done. Result saved to Bitpanda/bitpanda-live-urls-$TODAY.txt"

      - name: Set up Git user
        run: |
          git config --global user.email "${{ secrets.EMAIL_ADDRESS }}"
          git config --global user.name "${{ secrets.USER_NAME }}"

      - name: Commit changes
        run: |
          git add .
          git commit -m "Result scan $(date -u)" --no-verify || echo "Nothing to commit"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: master
